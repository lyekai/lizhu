<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>蒹葭 - 詩詞吟誦練習</title>
  <link rel="stylesheet" href="/static/reeds.css">
</head>
<body>
    <!-- 回上頁按鈕 -->
    <a href="/practice" class="back-button">⬅️ 回上頁</a>

    <!-- 主內容 -->
    <div class="reeds-container">
        <h1>蒹葭</h1>

        <!-- 第一段歌詞 -->
        <div class="lyrics-box">
            <p>蒹葭蒼蒼，白露為霜</p>
            <!-- 原音檔播放區 -->
            <div class="player-container">
                <button class="play-button" id="playBtn">▶️</button>
                <input type="range" id="progressBar" value="0" min="0" max="100" step="0.1">
            </div>
            <!-- 錄音控制區 -->
            <div class="record-container" style="margin-top:20px;">
                <div class="record-row">
                    <button id="recordBtn" class="record-button">🎙️</button>
                    <button id="playRecordBtn" class="record-button" style="display:none;">🔊</button>
                    <input type="range" id="recordProgress" value="0" min="0" max="100" step="0.1" style="display:none;">
                </div>
                <button id="scoreBtn" class="score-button" style="display:none;">📊 評分</button>
            </div>
            <!-- 即時計分結果 -->
            <div id="scoreResult" class="score-result" style="display:none; margin-top:25px;">
                <p>穩定度：<span id="clarityScore">--</span></p>
                <p>音準：<span id="pitchScore">--</span></p>
                <p>總分：<span id="totalScore">--</span></p>
            </div>
            <!-- 歷史最高分 -->
            <div class="history">
                <span class="history-label">歷史最高</span>
                <div id="historyResult" class="history-container">
                    <p>穩定度：<span id="bestClarity">0</span></p>
                    <p>音準：<span id="bestPitch">0</span></p>
                    <p>總分：<span id="bestTotal">0</span></p>
                </div>
            </div>
            <!-- 原始音檔 -->
            <audio id="audio" src="/static/jianjia/jianjia-1.mp3"></audio>
            <!-- 使用者錄音暫存 -->
            <audio id="recordedAudio" controls style="display:none;"></audio>
        </div>

        <!-- 第二段歌詞 -->
        <div class="lyrics-box">
            <p>所謂伊人，在水一方</p>

            <!-- 原音檔播放區 -->
            <div class="player-container">
                <button class="play-button" id="playBtn_2">▶️</button>
                <input type="range" id="progressBar_2" value="0" min="0" max="100" step="0.1">
            </div>

            <!-- 錄音控制區 -->
            <div class="record-container" style="margin-top:20px;">
                <div class="record-row">
                    <button id="recordBtn_2" class="record-button">🎙️</button>
                    <button id="playRecordBtn_2" class="record-button" style="display:none;">🔊</button>
                    <input type="range" id="recordProgress_2" value="0" min="0" max="100" step="0.1" style="display:none;">
                </div>
                <button id="scoreBtn_2" class="score-button" style="display:none;">📊 評分</button>
            </div>

            <!-- 即時計分結果 -->
            <div id="scoreResult_2" class="score-result" style="display:none; margin-top:25px;">
                <p>穩定度：<span id="clarityScore_2">--</span></p>
                <p>音準：<span id="pitchScore_2">--</span></p>
                <p>總分：<span id="totalScore_2">--</span></p>
            </div>

            <!-- 歷史最高分 -->
            <div class="history">
                <span class="history-label">歷史最高</span>
                <div id="historyResult_2" class="history-container">
                    <p>穩定度：<span id="bestClarity_2">0</span></p>
                    <p>音準：<span id="bestPitch_2">0</span></p>
                    <p>總分：<span id="bestTotal_2">0</span></p>
                </div>
            </div>

            <!-- 原始音檔 -->
            <audio id="audio_2" src="/static/jianjia/jianjia-2.mp3"></audio>
            <!-- 使用者錄音暫存 -->
            <audio id="recordedAudio_2" controls style="display:none;"></audio>
        </div>

        <!-- 第三段歌詞 -->
        <div class="lyrics-box">
            <p>溯洄從之，道阻且長，道阻且長</p>
            <!-- 原音檔播放區 -->
            <div class="player-container">
                <button class="play-button" id="playBtn_3">▶️</button>
                <input type="range" id="progressBar_3" value="0" min="0" max="100" step="0.1">
            </div>
            <!-- 錄音控制區 -->
            <div class="record-container" style="margin-top:20px;">
                <div class="record-row">
                    <button id="recordBtn_3" class="record-button">🎙️</button>
                    <button id="playRecordBtn_3" class="record-button" style="display:none;">🔊</button>
                    <input type="range" id="recordProgress_3" value="0" min="0" max="100" step="0.1" style="display:none;">
                </div>
                <button id="scoreBtn_3" class="score-button" style="display:none;">📊 評分</button>
            </div>
            <!-- 即時計分結果 -->
            <div id="scoreResult_3" class="score-result" style="display:none; margin-top:25px;">
                <p>穩定度：<span id="clarityScore_3">--</span></p>
                <p>音準：<span id="pitchScore_3">--</span></p>
                <p>總分：<span id="totalScore_3">--</span></p>
            </div>
            <!-- 歷史最高分 -->
            <div class="history">
                <span class="history-label">歷史最高</span>
                <div id="historyResult_3" class="history-container">
                    <p>穩定度：<span id="bestClarity_3">0</span></p>
                    <p>音準：<span id="bestPitch_3">0</span></p>
                    <p>總分：<span id="bestTotal_3">0</span></p>
                </div>
            </div>
            <!-- 原始音檔 -->
            <audio id="audio_3" src="/static/jianjia/jianjia-3.mp3"></audio>
            <!-- 使用者錄音暫存 -->
            <audio id="recordedAudio_3" controls style="display:none;"></audio>
        </div>
        
        <!-- 第四段歌詞 -->
        <div class="lyrics-box">
            <p>溯游從之，宛在水中央</p>
            <!-- 原音檔播放區 -->
            <div class="player-container">
                <button class="play-button" id="playBtn_4">▶️</button>
                <input type="range" id="progressBar_4" value="0" min="0" max="100" step="0.1">
            </div>
            <!-- 錄音控制區 -->
            <div class="record-container" style="margin-top:20px;">
                <div class="record-row">
                    <button id="recordBtn_4" class="record-button">🎙️</button>
                    <button id="playRecordBtn_4" class="record-button" style="display:none;">🔊</button>
                    <input type="range" id="recordProgress_4" value="0" min="0" max="100" step="0.1" style="display:none;">
                </div>
                <button id="scoreBtn_4" class="score-button" style="display:none;">📊 評分</button>
            </div>
            <!-- 即時計分結果 -->
            <div id="scoreResult_4" class="score-result" style="display:none; margin-top:25px;">
                <p>穩定度：<span id="clarityScore_4">--</span></p>
                <p>音準：<span id="pitchScore_4">--</span></p>
                <p>總分：<span id="totalScore_4">--</span></p>
            </div>
            <!-- 歷史最高分 -->
            <div class="history">
                <span class="history-label">歷史最高</span>
                <div id="historyResult_4" class="history-container">
                    <p>穩定度：<span id="bestClarity_4">0</span></p>
                    <p>音準：<span id="bestPitch_4">0</span></p>
                    <p>總分：<span id="bestTotal_4">0</span></p>
                </div>
            </div>
            <!-- 原始音檔 -->
            <audio id="audio_4" src="/static/jianjia/jianjia-4.mp3"></audio>
            <!-- 使用者錄音暫存 -->
            <audio id="recordedAudio_4" controls style="display:none;"></audio>
        </div>

        <!-- 第五段歌詞 -->
        <div class="lyrics-box">
            <p>蒹葭萋萋，白露未晞</p>
            <!-- 原音檔播放區 -->
            <div class="player-container">
                <button class="play-button" id="playBtn_5">▶️</button>
                <input type="range" id="progressBar_5" value="0" min="0" max="100" step="0.1">
            </div>
            <!-- 錄音控制區 -->
            <div class="record-container" style="margin-top:20px;">
                <div class="record-row">
                    <button id="recordBtn_5" class="record-button">🎙️</button>
                    <button id="playRecordBtn_5" class="record-button" style="display:none;">🔊</button>
                    <input type="range" id="recordProgress_5" value="0" min="0" max="100" step="0.1" style="display:none;">
                </div>
                <button id="scoreBtn_5" class="score-button" style="display:none;">📊 評分</button>
            </div>
            <!-- 即時計分結果 -->
            <div id="scoreResult_5" class="score-result" style="display:none; margin-top:25px;">
                <p>穩定度：<span id="clarityScore_5">--</span></p>
                <p>音準：<span id="pitchScore_5">--</span></p>
                <p>總分：<span id="totalScore_5">--</span></p>
            </div>
            <!-- 歷史最高分 -->
            <div class="history">
                <span class="history-label">歷史最高</span>
                <div id="historyResult_5" class="history-container">
                    <p>穩定度：<span id="bestClarity_5">0</span></p>
                    <p>音準：<span id="bestPitch_5">0</span></p>
                    <p>總分：<span id="bestTotal_5">0</span></p>
                </div>
            </div>
            <!-- 原始音檔 -->
            <audio id="audio_5" src="/static/jianjia/jianjia-5.mp3"></audio>
            <!-- 使用者錄音暫存 -->
            <audio id="recordedAudio_5" controls style="display:none;"></audio>
        </div>

        <!-- 第六段歌詞 -->
        <div class="lyrics-box">
            <p>所謂伊人，在水之湄</p>
            <!-- 原音檔播放區 -->
            <div class="player-container">
                <button class="play-button" id="playBtn_6">▶️</button>
                <input type="range" id="progressBar_6" value="0" min="0" max="100" step="0.1">
            </div>
            <!-- 錄音控制區 -->
            <div class="record-container" style="margin-top:20px;">
                <div class="record-row">
                    <button id="recordBtn_6" class="record-button">🎙️</button>
                    <button id="playRecordBtn_6" class="record-button" style="display:none;">🔊</button>
                    <input type="range" id="recordProgress_6" value="0" min="0" max="100" step="0.1" style="display:none;">
                </div>
                <button id="scoreBtn_6" class="score-button" style="display:none;">📊 評分</button>
            </div>
            <!-- 即時計分結果 -->
            <div id="scoreResult_6" class="score-result" style="display:none; margin-top:25px;">
                <p>穩定度：<span id="clarityScore_6">--</span></p>
                <p>音準：<span id="pitchScore_6">--</span></p>
                <p>總分：<span id="totalScore_6">--</span></p>
            </div>
            <!-- 歷史最高分 -->
            <div class="history">
                <span class="history-label">歷史最高</span>
                <div id="historyResult_6" class="history-container">
                    <p>穩定度：<span id="bestClarity_6">0</span></p>
                    <p>音準：<span id="bestPitch_6">0</span></p>
                    <p>總分：<span id="bestTotal_6">0</span></p>
                </div>
            </div>
            <!-- 原始音檔 -->
            <audio id="audio_6" src="/static/jianjia/jianjia-6.mp3"></audio>
            <!-- 使用者錄音暫存 -->
            <audio id="recordedAudio_6" controls style="display:none;"></audio>
        </div>

        <!-- 第七段歌詞 -->
        <div class="lyrics-box">
            <p>溯洄從之，道阻且躋，道阻且躋</p>
            <!-- 原音檔播放區 -->
            <div class="player-container">
                <button class="play-button" id="playBtn_7">▶️</button>
                <input type="range" id="progressBar_7" value="0" min="0" max="100" step="0.1">
            </div>
            <!-- 錄音控制區 -->
            <div class="record-container" style="margin-top:20px;">
                <div class="record-row">
                    <button id="recordBtn_7" class="record-button">🎙️</button>
                    <button id="playRecordBtn_7" class="record-button" style="display:none;">🔊</button>
                    <input type="range" id="recordProgress_7" value="0" min="0" max="100" step="0.1" style="display:none;">
                </div>
                <button id="scoreBtn_7" class="score-button" style="display:none;">📊 評分</button>
            </div>
            <!-- 即時計分結果 -->
            <div id="scoreResult_7" class="score-result" style="display:none; margin-top:25px;">
                <p>穩定度：<span id="clarityScore_7">--</span></p>
                <p>音準：<span id="pitchScore_7">--</span></p>
                <p>總分：<span id="totalScore_7">--</span></p>
            </div>
            <!-- 歷史最高分 -->
            <div class="history">
                <span class="history-label">歷史最高</span>
                <div id="historyResult_7" class="history-container">
                    <p>穩定度：<span id="bestClarity_7">0</span></p>
                    <p>音準：<span id="bestPitch_7">0</span></p>
                    <p>總分：<span id="bestTotal_7">0</span></p>
                </div>
            </div>
            <!-- 原始音檔 -->
            <audio id="audio_7" src="/static/jianjia/jianjia-7.mp3"></audio>
            <!-- 使用者錄音暫存 -->
            <audio id="recordedAudio_7" controls style="display:none;"></audio>
        </div>

        <!-- 第八段歌詞 -->
        <div class="lyrics-box">
            <p>溯游從之，宛在水中坻</p>
            <!-- 原音檔播放區 -->
            <div class="player-container">
                <button class="play-button" id="playBtn_8">▶️</button>
                <input type="range" id="progressBar_8" value="0" min="0" max="100" step="0.1">
            </div>
            <!-- 錄音控制區 -->
            <div class="record-container" style="margin-top:20px;">
                <div class="record-row">
                    <button id="recordBtn_8" class="record-button">🎙️</button>
                    <button id="playRecordBtn_8" class="record-button" style="display:none;">🔊</button>
                    <input type="range" id="recordProgress_8" value="0" min="0" max="100" step="0.1" style="display:none;">
                </div>
                <button id="scoreBtn_8" class="score-button" style="display:none;">📊 評分</button>
            </div>
            <!-- 即時計分結果 -->
            <div id="scoreResult_8" class="score-result" style="display:none; margin-top:25px;">
                <p>穩定度：<span id="clarityScore_8">--</span></p>
                <p>音準：<span id="pitchScore_8">--</span></p>
                <p>總分：<span id="totalScore_8">--</span></p>
            </div>
            <!-- 歷史最高分 -->
            <div class="history">
                <span class="history-label">歷史最高</span>
                <div id="historyResult_8" class="history-container">
                    <p>穩定度：<span id="bestClarity_8">0</span></p>
                    <p>音準：<span id="bestPitch_8">0</span></p>
                    <p>總分：<span id="bestTotal_8">0</span></p>
                </div>
            </div>
            <!-- 原始音檔 -->
            <audio id="audio_8" src="/static/jianjia/jianjia-8.mp3"></audio>
            <!-- 使用者錄音暫存 -->
            <audio id="recordedAudio_8" controls style="display:none;"></audio>
        </div>

        <!-- 第九段歌詞 -->
        <div class="lyrics-box">
            <p>蒹葭采采，白露未已</p>
            <!-- 原音檔播放區 -->
            <div class="player-container">
                <button class="play-button" id="playBtn_9">▶️</button>
                <input type="range" id="progressBar_9" value="0" min="0" max="100" step="0.1">
            </div>
            <!-- 錄音控制區 -->
            <div class="record-container" style="margin-top:20px;">
                <div class="record-row">
                    <button id="recordBtn_9" class="record-button">🎙️</button>
                    <button id="playRecordBtn_9" class="record-button" style="display:none;">🔊</button>
                    <input type="range" id="recordProgress_9" value="0" min="0" max="100" step="0.1" style="display:none;">
                </div>
                <button id="scoreBtn_9" class="score-button" style="display:none;">📊 評分</button>
            </div>
            <!-- 即時計分結果 -->
            <div id="scoreResult_9" class="score-result" style="display:none; margin-top:25px;">
                <p>穩定度：<span id="clarityScore_9">--</span></p>
                <p>音準：<span id="pitchScore_9">--</span></p>
                <p>總分：<span id="totalScore_9">--</span></p>
            </div>
            <!-- 歷史最高分 -->
            <div class="history">
                <span class="history-label">歷史最高</span>
                <div id="historyResult_9" class="history-container">
                    <p>穩定度：<span id="bestClarity_9">0</span></p>
                    <p>音準：<span id="bestPitch_9">0</span></p>
                    <p>總分：<span id="bestTotal_9">0</span></p>
                </div>
            </div>
            <!-- 原始音檔 -->
            <audio id="audio_9" src="/static/jianjia/jianjia-9.mp3"></audio>
            <!-- 使用者錄音暫存 -->
            <audio id="recordedAudio_9" controls style="display:none;"></audio>
        </div>

        <!-- 第十段歌詞 -->
        <div class="lyrics-box">
            <p>所謂伊人，在水之涘</p>
            <!-- 原音檔播放區 -->
            <div class="player-container">
                <button class="play-button" id="playBtn_10">▶️</button>
                <input type="range" id="progressBar_10" value="0" min="0" max="100" step="0.1">
            </div>
            <!-- 錄音控制區 -->
            <div class="record-container" style="margin-top:20px;">
                <div class="record-row">
                    <button id="recordBtn_10" class="record-button">🎙️</button>
                    <button id="playRecordBtn_10" class="record-button" style="display:none;">🔊</button>
                    <input type="range" id="recordProgress_10" value="0" min="0" max="100" step="0.1" style="display:none;">
                </div>
                <button id="scoreBtn_10" class="score-button" style="display:none;">📊 評分</button>
            </div>
            <!-- 即時計分結果 -->
            <div id="scoreResult_10" class="score-result" style="display:none; margin-top:25px;">
                <p>穩定度：<span id="clarityScore_10">--</span></p>
                <p>音準：<span id="pitchScore_10">--</span></p>
                <p>總分：<span id="totalScore_10">--</span></p>
            </div>
            <!-- 歷史最高分 -->
            <div class="history">
                <span class="history-label">歷史最高</span>
                <div id="historyResult_10" class="history-container">
                    <p>穩定度：<span id="bestClarity_10">0</span></p>
                    <p>音準：<span id="bestPitch_10">0</span></p>
                    <p>總分：<span id="bestTotal_10">0</span></p>
                </div>
            </div>
            <!-- 原始音檔 -->
            <audio id="audio_10" src="/static/jianjia/jianjia-10.mp3"></audio>
            <!-- 使用者錄音暫存 -->
            <audio id="recordedAudio_10" controls style="display:none;"></audio>
        </div>

        <!-- 第十一段歌詞 -->
        <div class="lyrics-box">
            <p>溯洄從之，道阻且右，道阻且右</p>
            <!-- 原音檔播放區 -->
            <div class="player-container">
                <button class="play-button" id="playBtn_11">▶️</button>
                <input type="range" id="progressBar_11" value="0" min="0" max="100" step="0.1">
            </div>
            <!-- 錄音控制區 -->
            <div class="record-container" style="margin-top:20px;">
                <div class="record-row">
                    <button id="recordBtn_11" class="record-button">🎙️</button>
                    <button id="playRecordBtn_11" class="record-button" style="display:none;">🔊</button>
                    <input type="range" id="recordProgress_11" value="0" min="0" max="100" step="0.1" style="display:none;">
                </div>
                <button id="scoreBtn_11" class="score-button" style="display:none;">📊 評分</button>
            </div>
            <!-- 即時計分結果 -->
            <div id="scoreResult_11" class="score-result" style="display:none; margin-top:25px;">
                <p>穩定度：<span id="clarityScore_11">--</span></p>
                <p>音準：<span id="pitchScore_11">--</span></p>
                <p>總分：<span id="totalScore_11">--</span></p>
            </div>
            <!-- 歷史最高分 -->
            <div class="history">
                <span class="history-label">歷史最高</span>
                <div id="historyResult_11" class="history-container">
                    <p>穩定度：<span id="bestClarity_11">0</span></p>
                    <p>音準：<span id="bestPitch_11">0</span></p>
                    <p>總分：<span id="bestTotal_11">0</span></p>
                </div>
            </div>
            <!-- 原始音檔 -->
            <audio id="audio_11" src="/static/jianjia/jianjia-11.mp3"></audio>
            <!-- 使用者錄音暫存 -->
            <audio id="recordedAudio_11" controls style="display:none;"></audio>
        </div>

        <!-- 第十二段歌詞 -->
        <div class="lyrics-box">
            <p>溯游從之，宛在水中沚</p>
            <!-- 原音檔播放區 -->
            <div class="player-container">
                <button class="play-button" id="playBtn_12">▶️</button>
                <input type="range" id="progressBar_12" value="0" min="0" max="100" step="0.1">
            </div>
            <!-- 錄音控制區 -->
            <div class="record-container" style="margin-top:20px;">
                <div class="record-row">
                    <button id="recordBtn_12" class="record-button">🎙️</button>
                    <button id="playRecordBtn_12" class="record-button" style="display:none;">🔊</button>
                    <input type="range" id="recordProgress_12" value="0" min="0" max="100" step="0.1" style="display:none;">
                </div>
                <button id="scoreBtn_12" class="score-button" style="display:none;">📊 評分</button>
            </div>
            <!-- 即時計分結果 -->
            <div id="scoreResult_12" class="score-result" style="display:none; margin-top:25px;">
                <p>穩定度：<span id="clarityScore_12">--</span></p>
                <p>音準：<span id="pitchScore_12">--</span></p>
                <p>總分：<span id="totalScore_12">--</span></p>
            </div>
            <!-- 歷史最高分 -->
            <div class="history">
                <span class="history-label">歷史最高</span>
                <div id="historyResult_12" class="history-container">
                    <p>穩定度：<span id="bestClarity_12">0</span></p>
                    <p>音準：<span id="bestPitch_12">0</span></p>
                    <p>總分：<span id="bestTotal_12">0</span></p>
                </div>
            </div>
            <!-- 原始音檔 -->
            <audio id="audio_12" src="/static/jianjia/jianjia-12.mp3"></audio>
            <!-- 使用者錄音暫存 -->
            <audio id="recordedAudio_12" controls style="display:none;"></audio>
        </div>
    </div>

  <script>
    function initLyricsBox(prefix) {
        const audio = document.getElementById(`audio${prefix}`);
        const playBtn = document.getElementById(`playBtn${prefix}`);
        const progressBar = document.getElementById(`progressBar${prefix}`);
        const recordBtn = document.getElementById(`recordBtn${prefix}`);
        const playRecordBtn = document.getElementById(`playRecordBtn${prefix}`);
        const recordProgress = document.getElementById(`recordProgress${prefix}`);
        const recordedAudio = document.getElementById(`recordedAudio${prefix}`);
        const scoreBtn = document.getElementById(`scoreBtn${prefix}`);
        const scoreResult = document.getElementById(`scoreResult${prefix}`);

        const bestClarity = document.getElementById(`bestClarity${prefix}`);
        const bestPitch = document.getElementById(`bestPitch${prefix}`);
        const bestTotal = document.getElementById(`bestTotal${prefix}`);

        bestClarity.textContent = localStorage.getItem(`bestClarity${prefix}`) || 0;
        bestPitch.textContent = localStorage.getItem(`bestPitch${prefix}`) || 0;
        bestTotal.textContent = localStorage.getItem(`bestTotal${prefix}`) || 0;

        let mediaRecorder;
        let audioChunks = [];

        playBtn.addEventListener("click", () => {
            if (audio.paused) {
            audio.play();
            playBtn.textContent = "⏸️";
            } else {
            audio.pause();
            playBtn.textContent = "▶️";
            }
        });

        audio.addEventListener("timeupdate", () => {
            progressBar.value = (audio.currentTime / audio.duration) * 100;
        });
        progressBar.addEventListener("input", () => {
            audio.currentTime = (progressBar.value / 100) * audio.duration;
        });
        audio.addEventListener("ended", () => {
            playBtn.textContent = "▶️";
            progressBar.value = 0;
        });

        recordBtn.addEventListener("click", async () => {
            if (!mediaRecorder || mediaRecorder.state === "inactive") {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                mediaRecorder.ondataavailable = (e) => audioChunks.push(e.data);
                mediaRecorder.onstop = () => {
                const blob = new Blob(audioChunks, { type: "audio/webm" });
                const audioUrl = URL.createObjectURL(blob);
                recordedAudio.src = audioUrl;
                recordedAudio.style.display = "none";
                playRecordBtn.style.display = "inline-block";
                scoreBtn.style.display = "inline-block";
                };
                mediaRecorder.start();
                recordBtn.textContent = "⏹️";
            } catch (err) {
                alert("無法啟用麥克風，請確認權限已開啟。");
                console.error(err);
            }
            } else {
            mediaRecorder.stop();
            recordBtn.textContent = "🎙️";
            }
        });

        playRecordBtn.addEventListener("click", () => {
            recordProgress.style.display = "inline-block";
            recordedAudio.play();
            recordedAudio.addEventListener("timeupdate", () => {
            recordProgress.value = (recordedAudio.currentTime / recordedAudio.duration) * 100;
            });
        });

        scoreBtn.addEventListener("click", async () => {
        scoreBtn.disabled = true;
        scoreBtn.textContent = "⏳ 分析中...";
        const blob = await fetch(recordedAudio.src).then(r => r.blob());
        const formData = new FormData();
        formData.append("audio", blob, `user_recording${prefix}.webm`);
        // ✅ 傳遞對應段落參數給 Flask
        // formData.append("segment", prefix === "_2" ? "2" : "1");
        formData.append("segment", prefix ? prefix.replace("_", "") : "1");
        formData.append("song", "jianjia");

        try {
            const res = await fetch("/evaluate_audio", { method: "POST", body: formData });
            const data = await res.json();

            scoreResult.style.display = "flex";
            document.getElementById(`clarityScore${prefix}`).textContent = data.stability;
            document.getElementById(`pitchScore${prefix}`).textContent = data.pitch;
            document.getElementById(`totalScore${prefix}`).textContent = data.total;

            updateBestScores(prefix, data.stability, data.pitch, data.total);
        } catch (err) {
            alert("評分失敗，請稍後再試。");
            console.error(err);
        } finally {
            scoreBtn.textContent = "📊 評分";
            scoreBtn.disabled = false;
        }
        });
    }

    function updateBestScores(prefix, stability, pitch, total) {
      let bestC = parseFloat(localStorage.getItem(`bestClarity${prefix}`)) || 0;
      let bestP = parseFloat(localStorage.getItem(`bestPitch${prefix}`)) || 0;
      let bestT = parseFloat(localStorage.getItem(`bestTotal${prefix}`)) || 0;

      if (stability > bestC) {
        bestC = stability;
        localStorage.setItem(`bestClarity${prefix}`, stability);
      }
      if (pitch > bestP) {
        bestP = pitch;
        localStorage.setItem(`bestPitch${prefix}`, pitch);
      }
      if (total > bestT) {
        bestT = total;
        localStorage.setItem(`bestTotal${prefix}`, total);
      }

      document.getElementById(`bestClarity${prefix}`).textContent = bestC;
      document.getElementById(`bestPitch${prefix}`).textContent = bestP;
      document.getElementById(`bestTotal${prefix}`).textContent = bestT;
    }

    // 初始化兩段歌詞
    initLyricsBox("");   // 第一段
    initLyricsBox("_2"); // 第二段
    initLyricsBox("_3");
    initLyricsBox("_4");
    initLyricsBox("_5");
    initLyricsBox("_6");
    initLyricsBox("_7");
    initLyricsBox("_8");
    initLyricsBox("_9");
    initLyricsBox("_10");
    initLyricsBox("_11");
    initLyricsBox("_12");
  </script>
</body>
</html>
